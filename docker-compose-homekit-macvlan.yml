version: '3.8'
services:
  iobroker:
    image: tillsteinbach/vwsfriend-iobroker:latest
    networks:
      homekit-network:
        ipv4_address: ${HOMEKIT_IP}
      backend:
        aliases:
          - iobrokerbackend
    volumes:
      - iobroker_data:/opt/iobroker
    ports:
      - 8081:8081
    environment:
      - AVAHI=true
      - HOMEKIT=true
      - INFLUXDB_ADMIN_USER=${DB_USER}
      - INFLUXDB_ADMIN_PASSWORD=${DB_PASSWORD}
      - INFLUXDB_DB=iobroker
      - VWCONNECT_USER
      - VWCONNECT_PASSWORD
      - VWCONNECT_PIN
      - VWCONNECT_TYPE=id
      - VWCONNECT_INTERVAL
      - HOMEKIT_IP
      - HOMEKIT_USERNAME
      - HOMEKIT_PIN
  influxdb:
    image: influxdb:1.8
    expose:
      - 8086
    networks:
      backend:
        aliases:
          - influxdbbackend
    volumes:
      - influxdb_data:/var/lib/influxdb
    environment:
      - INFLUXDB_ADMIN_USER=${DB_USER}
      - INFLUXDB_ADMIN_PASSWORD=${DB_PASSWORD}
      - INFLUXDB_DB=iobroker
    healthcheck:
      test: (wget -qO- http://localhost:8086/metrics | grep "# HELP" -q) || exit 1
      interval: 60s
      timeout: 10s
      retries: 3

  grafana:
    image: tillsteinbach/vwsfriend-grafana:latest
    ports:
      - 3001:3000
    networks:
      bridge:
      backend:
        aliases:
          - grafanabackend
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${USERNAME}
      - GF_SECURITY_ADMIN_PASSWORD=${PASSWORD}
    healthcheck:
      test: (wget -qO- http://localhost:3000 | grep "<title>Grafana</title>" -q) || exit 1
      interval: 60s
      timeout: 10s
      retries: 3

networks:
  bridge:
  homekit-network:
    driver: macvlan
    driver_opts:
      parent: ${HOMEKIT_INTERFACE}
    ipam:
      config:
        - subnet: ${HOMEKIT_MASK}
          ip_range: ${HOMEKIT_IP}/32
          gateway: ${HOMEKIT_GW}
  backend:

volumes:
  iobroker_data:
  influxdb_data:
  grafana_data:
